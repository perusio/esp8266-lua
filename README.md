# Connecting the ESP8266 MCU using Lua to the relayr cloud

## Introduction

This repository contains the code for connecting to the relayr cloud
and publish and/or subscribe to
[MQTT](https://en.wikipedia.org/wiki/MQTT) topics defined in the
relayr broker.

You need an account in the
[relayr dashboard](https://developer.relayr.io) to make use of this
code. It can be repurposed for other MQTT broker of course, but you
have to adapt the current logic.

The code is organized in **three** directories:

 + `modules`: contains the modules that launch the WiFi connection,
    MQTT client support and configuration.
 +  `t`: contains tests.
 + base directory contains the `app.lua` file where all the
   **specific** application logic is defined.
   
`app.lua` is a just a grab-bag of examples using several types of
sensors as data sources and output devices as actuators.

## Writing your own application

The `app.lua` file contains two types of callbacks:

 + `send_data`: that **publishes** data to a particular topic in the
   MQTT broker.
 + `received_data`: that **subscribes** to a particular topic in the
   MQTT broker.
   
To understand those functions you need first to understand the
[device model](http://docs.relayr.io/getting-started/device-models-guide/).

Briefly a device model is a schema describing what type of data
streams a device can consume and/or receive. The data streams are
usually serialized as JSON. Note that we use here _loosely_ the term
stream. Is not a stream in the sense of a **continuous** flow of
values, but rather as a source/sink of data to/from the MQTT broker.

It is beyond the scope of this document to delve deeply into device
models and how the relayr MQTT broker topics are organized. Instead we
provide examples of sensors (data in the relayr parlance) and
actuators (commands in the relayr parlance) in the `app.lua` file.

Let's take as example the data generated by a
[DHT22](https://cdn-shop.adafruit.com/datasheets/DHT22.pdf)
temperature and humidity sensor. 

In this example we plug the `DATA` output from the sensor to pin **5**
of the Node MCU ESP8266 microcontroller. We publish data to the MQTT
broker every 2.5 seconds.

```lua
--- Gets the readings from a DHT11 or DHT22 sensor.
--
-- @param integer pin
--   The GPIO (input) pin number
-- @return tabĺe
--   The table with the meaning(s) and value(s).
local function dht_data_source(pin)
  -- Read the data from the DHT sensor.
  local status, temp, hum = dht.read(pin)
  -- Retunr the values.
  return{
    {
      meaning = 'temperature',
      value = temp
    },
    {
      meaning = 'humidity',
      value = hum
    },
  }
end

--- Wrapper for sending data to the relayr cloud.
--
-- @return nothing.
--   Side effects only.
local function send_data()
  relayr.send(dht_data_source(5))
end

--- Setup whatever you need in order to send
--  data and connect to the relayr cloud to
--
-- @return nothing.
--  Side effects only.
local function setup(subs_topics)
  -- Setup GPIO as an output.
  -- gpio.mode(output_pin, gpio.OUTPUT)
  -- Register the function (callback) in which you
  -- whish to process incoming data (commands).
  relayr.register_data_listener(received_data)
  -- Connect to relayr Cloud.
  relayr.connect(
    -- Pass the MQTT configuration.
    config.mqtt,
    -- Callback when the connection is established.
    -- Invoke this function every app_config.data_period ms.
    function()
      alarm(config.app.data_timer,
            config.app.data_period,
            tmr.ALARM_AUTO,
            send_data)
    end,
    subs_topics
  )
end

```

The `dht_data_source` function returns a JSON that fits a particular
device model and the `received_data` function is the callback for the
subscribed topics.

You can of course make this more complex and **decouple** the
publishing from the subscribing. Do that effect you can use multiple
timers. This is the simplest possible example of both publish and
subscribe.

Separation of concerns is always good practice in real world
applications.

There are many possible
[applications](http://nodemcu.readthedocs.io/en/master/en/modules/)
to be written. Is up to you to adapt this code to your particular
needs.

## Getting the base firmware 

This is the process to follow for using the DHT sensor as input to
publish to the MQTT broker-

 1. Go to [Node MCU Build](http://nodemcu-build.com/index.php) and
    select the **dev** branch and the following modules:
    
    + [CJSON](http://nodemcu.readthedocs.io/en/master/en/modules/cjson/)
    + [DHT](http://nodemcu.readthedocs.io/en/master/en/modules/dht/)
    + [MQTT](http://nodemcu.readthedocs.io/en/master/en/modules/mqtt/)

    the other needed modules should be **pre-selected**
    
    + [file](http://nodemcu.readthedocs.io/en/master/en/modules/file/)
    + [GPIO](http://nodemcu.readthedocs.io/en/master/en/modules/gpio/)
    + [net](http://nodemcu.readthedocs.io/en/master/en/modules/net/)
    + [node](http://nodemcu.readthedocs.io/en/master/en/modules/node/)
    + [timer](http://nodemcu.readthedocs.io/en/master/en/modules/tmr/)
    + [UART](http://nodemcu.readthedocs.io/en/master/en/modules/uart/)
    + [WiFi](http://nodemcu.readthedocs.io/en/master/en/modules/wifi/)
 
 2. You'll receive an email when the build starts and another one when
    the build finished. There are **two** versions one using
    **floating** point numbers the other with **integers**. You choose
    any of them for this case. For other application it might be
    important to use one or the other.
    
 3. Download the `bin` file(s) from the link(s) in the mail sent by
    the build bot once the build has finished.
    
## Flashing the firmware onto the device

### Communicating with the device via serial port - USB

There are a profusion of devices out there. What interest us is the
chip used for the USB to UART
interface. [Here](http://frightanic.com/iot/comparison-of-esp8266-nodemcu-development-boards/)
a description of the various development boards. The most common use
either the
[CP2102](http://www.silabs.com/Support%20Documents/TechnicalDocs/CP2102-9.pdf)
or the
[CH340](http://www.seeedstudio.com/wiki/images/7/7c/CH340DS1_EN.PDF).

We concern ourselves here either with the
[Amica](http://www.electrodragon.com/product/nodemcu-lua-amica-r2-esp8266-wifi-board/)
NodeMCU v2 or the
[WeMos D1 mini](http://www.wemos.cc/Products/d1_mini.html).

 + For the Amica boards and others based on the CP2102 use
   [this driver](https://www.pololu.com/docs/0j7/all).
 + For the WeMos use [this driver](http://www.wemos.cc/downloads/).
 
### Flashing the firmware
 
 +  If using Linux or OSX install the
    [esptool](https://github.com/themadinventor/esptool).
 + If using Windows get the
   [NodeMCU flasher for Win 32](https://github.com/nodemcu/nodemcu-flasher/raw/master/Win32/Release/ESP8266Flasher.exe).
   or the
   [NodeMCU flahser for Win 64](https://github.com/nodemcu/nodemcu-flasher/raw/master/Win64/Release/ESP8266Flasher.exe).
   
#### Flashing on Linux and OSX 

Plug your board into your computer USB port and go to the `esptool`
directory. Issue the command:


```shell
 ./esptool.py --port /dev/ttyUSB0 write_flash -fm dio -fs 32m -ff 40m 0x00000 /path/to/firmware.bin
```

where: 

 + `/dev/ttyUSB0` is the **Linux** serial device associated with the NodeMCU
   board. It might vary depending on your specifc setup.
   
 + Do `ls /dev/cu*` to see the name of the device in your OSX machine (Mac).

 + `firmware.bin` is one of the bin files you downloaded from the
   firmware build site above. 
   
For example, in Linux:

```shell
 ./esptool.py --port /dev/ttyUSB0 write_flash -fm dio -fs 32m -ff 40m 0x00000 nodemcu-master-10-modules-2016-03-17-10-58-23-float.bin
```

You should see the blue led on the board blinking as the counter
progresses up to 100% when the flashing completes.

#### Flashing on Windows

Follow the instructions on the
[README](https://github.com/nodemcu/nodemcu-flasher/) for the github
project.


## Communicating with the device and uploading code

There are two options for this. One uses the command line, the other
uses an IDE.

### IDE for the ESP8266

[ESPlorer](http://esp8266.ru/esplorer/) is a Java based IDE for
working with the ESP8266. It requires the Oracle 
[Java Runtime Environment](http://www.oracle.com/technetwork/java/javase/downloads/jre8-downloads-2133155.html)
or
[Java Development KitK](http//www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html).

### Command line tool: luatool

[luatool](https://github.com/4refr0nt/luatool) is a Python script that
communicates with the ESP8266 using the serial port and sends the
file(s) line by line to the device.

### Format the device

The ESP8266 official SDK uses Lua and relies on a Flash based
filesystem to run code in files.

If on the ESPlorer press the `format` button. 

If on the command line:

 1. Open a serial communications program like
    [picocom](https://github.com/npat-efault/picocom) in LInux and OSX
    or [Putty](http://www.putty.org/) in Windows.
    
    
        picocom -b 115200 /dev/ttyUSB0
        
    adapt the the name of the serial device the ESP8266 shows up as.
    
 2. Issue the command: 

        file.format()
    
It takes a while to format the file system. Once we're done we can now
upload files to the device.

### Uploading files to the device

With the ESPlorer is very simple. Just use the buttons on the UI.

On the command line:

 1. Go to the `luatool` directory.
 2. Issue the command:
 
        ./luatool/luatool.py -p /dev/ttyUSB0 -b 115200 -f /path/to/code_file.lua
        
    where `/path/to/code_file.lua` is the path to the Lua file you
    want to upload.
    
 3. Done.
 
## Running the code for the relayr cloud

 1. Clone the repository:
 
        git clone git@github.com:relayr/ESP8266_Lua.git
        
 2. Upload the files one by one. If using the ESPlorer select and
    upload. If on the command line with `luatool`

    
        /luatool/luatool.py -p /dev/ttyUSB0 -b 115200 -f /path/to/ESP8266_Lua/modules/wifi_launch.lua 
        /luatool/luatool.py -p /dev/ttyUSB0 -b 115200 -f /path/to/ESP8266_Lua/modules/relayr_mqtt.lua
        /luatool/luatool.py -p /dev/ttyUSB0 -b 115200 -f /path/to/ESP8266_Lua/app.lua
 
 3. Edit the `config.lua` file and add your WiFi credentials and the
    credentials you get from the relayr
    [dashboard](https://developer.relayr.io). Upload it.
    
            /luatool/luatool.py -p /dev/ttyUSB0 -b 115200 -f /path/to/ESP8266_Lua/modules/config.lua
                        
 4. Now we can run the code. 
 
    + On the ESPlorer just do `dofile('app.lua')`.
    + On the command line open a terminal program like picocom or
      Putty and do: `dofile('app.lua')`.
      
 5. You should start seeing the data being visualized on the
    dashboard.
    
## Debugging and troubleshooting

The `wifi_launch` and `relayr_mqtt` can print debugging messages in
the terminal for that in the `app.lua` file do:

```lua
relayr._DEBUG = true -- for the relayr_mqtt debugging messages
wifi_setup._DEBUG = true -- for the wifi_launch debugging messages
```

## Testing 

There's a `/t` directory where we have tests for the functionality.

### WiFi setup testing

The script `wifi_test.lua` is a test for the WiFi setup. 

 1. Upload the file to the device: 

     /luatool/luatool.py -p /dev/ttyUSB0 -b 115200 -f /path/to/ESP8266_Lua/t/wifi:_test.lua
        
 2. Run: `dofile('wifi_test.lua')`.
 3. You should see the assigned IP address, netmask and gateway IP
    address. 


## Going further

relayr provides hands-on workshops every second Thursday of every
month. [Come](https://www.eventbrite.com/e/understanding-iot-protocols-using-the-esp-8266-mqtt-coap-http-and-websockets-tickets-21205029815)
join us to see all this code in action.


## License

 Copyright (C) 2016 relayr GmbH, Klemen Lilija <klemen@relayr.de>, 
 António P. P. Almeida <appa@perusio.net> 

 Permission is hereby granted, free of charge, to any person obtaining a 
 copy of this software and associated documentation files (the "Software"), 
 to deal in the Software without restriction, including without limitation 
 the rights to use, copy, modify, merge, publish, distribute, sublicense, 
 and/or sell copies of the Software, and to permit persons to whom the 
 Software is furnished to do so, subject to the following conditions: 

 The above copyright notice and this permission notice shall be included in 
 all copies or substantial portions of the Software. 

 Except as contained in this notice, the name(s) of the above copyright 
 holders shall not be used in advertising or otherwise to promote the sale, 
 use or other dealings in this Software without prior written authorization. 

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR 
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL 
 THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER 
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING 
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER 
 DEALINGS IN THE SOFTWARE. 

## TODO

 + Add test for the MQTT connection/publishing/subscribing.
 
 
